<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fogorvosi bevételkövető – Rögzítés</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e6eaf1;--primary:#2563eb;--danger:#ef4444;--ok:#16a34a;--shadow:0 6px 25px rgba(15,23,42,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  .layout{max-width:700px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:16px}
  h1{font-size:20px;margin:0 0 8px}
  h2{font-size:16px;margin:0 0 10px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .toolbar{display:flex;gap:8px;justify-content:flex-end;align-items:center;margin-top:10px}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;text-decoration:none;color:inherit}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn.link{background:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .hide{display:none}
  .alert{padding:10px 12px;border-radius:10px;font-weight:600}
  .alert.ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}
  .alert.err{background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .muted{color:var(--muted);font-size:12px}
  .nav{display:flex;gap:8px;align-items:center}

  /* Gyors beavatkozás kártyák */
  .quick-wrap{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px}
  .chip-btn{
    display:inline-flex;align-items:center;gap:6px;
    padding:8px 10px;border:1px solid var(--line);border-radius:999px;
    background:#fff;cursor:pointer;font-weight:600
  }
  .chip-btn:hover{box-shadow:0 2px 10px rgba(15,23,42,.08)}

  /* Loader overlay */
  .loader{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:var(--bg);z-index:9999;transition:opacity .25s ease;
  }
  .loader.hide{opacity:0;pointer-events:none}
  .loader-inner{display:flex;flex-direction:column;align-items:center;gap:12px}
  .tooth{width:64px;height:64px}
  .spin{animation:spin 1.1s linear infinite}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .loader-text{color:var(--muted);font-weight:600}
</style>
</head>
<body>
<!-- BETÖLTŐ KÉPERNYŐ -->
<div id="loader" class="loader">
  <div class="loader-inner">
    <!-- mosolygó fogacska (SVG) pörgő módban -->
    <svg class="tooth spin" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Betöltés">
      <path d="M20 8c-6 0-10 5-10 12 0 9 5 14 9 17 4 3 5 15 9 15s5-9 9-9 5 9 9 9 5-12 9-15c4-3 9-8 9-17 0-7-4-12-10-12-5 0-9 2-12 5-3-3-7-5-12-5z" stroke="#2563eb" stroke-width="2" fill="#fff"/>
      <circle cx="26" cy="24" r="2.5" fill="#0f172a"/>
      <circle cx="38" cy="24" r="2.5" fill="#0f172a"/>
      <path d="M24 33c2 3 6 5 8 5s6-2 8-5" stroke="#0f172a" stroke-width="2" stroke-linecap="round" />
    </svg>
    <div class="loader-text">Betöltés…</div>
  </div>
</div>

<div class="layout" id="app">
  <div class="topbar">
    <h1>Fogorvosi bevételkövető – Rögzítés</h1>
    <div class="nav">
      <a class="btn link" href="settings.html">Beállítások</a>
      <a class="btn link" href="income.html">Bevételek</a>
      <span id="userBox" class="muted"></span>
    </div>
  </div>

  <!-- Auth -->
  <div class="card" id="authCard">
    <h2>Bejelentkezés</h2>
    <div class="row">
      <div>
        <label>E-mail</label>
        <input type="email" id="email">
      </div>
      <div>
        <label>Jelszó</label>
        <input type="password" id="password">
      </div>
    </div>
    <div class="toolbar">
      <button class="btn primary" id="loginBtn">Belépés</button>
      <button class="btn" id="registerBtn">Regisztráció</button>
    </div>
    <div class="muted" id="authMsg"></div>
  </div>

  <!-- Rögzítő oldal -->
  <div id="appContent" class="hide">
    <div class="card">
      <div class="topbar">
        <h2>Új bejegyzés</h2>
        <button class="btn" id="logoutBtn">Kijelentkezés</button>
      </div>

      <div id="saveOk" class="alert ok hide">Sikeresen mentve ✓</div>
      <div id="saveErr" class="alert err hide"></div>

      <div class="row">
        <div>
          <label>Dátum</label>
          <input type="date" id="date">
        </div>
        <div>
          <label>Páciens neve</label>
          <input type="text" id="patient" placeholder="Pl. Kiss Anna">
        </div>
      </div>

      <div>
        <label>Beavatkozás</label>
        <input type="text" id="procedure" placeholder="Pl. tömés, gyökérkezelés…">
        <!-- Gyors beavatkozások (kattintható kártyák) -->
        <div id="quickProcedures" class="quick-wrap"></div>
      </div>

      <div class="row">
        <div>
          <label>Fizetett összeg (HUF)</label>
          <input type="number" id="amount" min="0" step="1" placeholder="pl. 25000">
        </div>
        <div>
          <label>Munkahely</label>
          <select id="workplace"></select>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn" id="resetBtn">Mezők törlése</button>
        <button class="btn primary" id="saveBtn">Mentés</button>
      </div>

      <div class="muted">A részletes számolás a külön oldalakon lesz. Itt most csak a rögzítés történik.</div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // >>> saját config
  const firebaseConfig = {
    apiKey: "AIzaSyBGVBozEiKhqOqvvYB9Qsm1xCLrsw0itNI",
    authDomain: "dental-38375.firebaseapp.com",
    projectId: "dental-38375",
    storageBucket: "dental-38375.appspot.com",
    messagingSenderId: "245424156358",
    appId: "1:245424156358:web:e6426588b20675756331c7",
    measurementId: "G-WC90WMHRZT"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI elemek
  const loader = document.getElementById('loader');
  const authCard = document.getElementById('authCard');
  const appContent = document.getElementById('appContent');
  const userBox = document.getElementById('userBox');
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authMsg = document.getElementById('authMsg');

  const dateEl = document.getElementById('date');
  const patientEl = document.getElementById('patient');
  const procedureEl = document.getElementById('procedure');
  const quickWrap = document.getElementById('quickProcedures');
  const amountEl = document.getElementById('amount');
  const workplaceEl = document.getElementById('workplace');
  const resetBtn = document.getElementById('resetBtn');
  const saveBtn = document.getElementById('saveBtn');

  const saveOk = document.getElementById('saveOk');
  const saveErr = document.getElementById('saveErr');

  let currentUID = null;
  let settings = {
    w1name:'Hely1', w1pct:0.30, w1color:'#2563eb',
    w2name:'Hely2', w2pct:0.40, w2color:'#16a34a',
    procedures: [] // gyors beavatkozások
  };

  // segéd: loader vezérlés
  const hideLoader = ()=> loader.classList.add('hide');
  const showLoader = ()=> loader.classList.remove('hide');

  // kontraszt számítás
  const hexToRgb = (hex)=>{ const h=hex.replace('#',''); const b=parseInt(h.length===3?h.split('').map(x=>x+x).join(''):h,16); return {r:(b>>16)&255,g:(b>>8)&255,b:b&255}; };
  const contrast = (hex)=>{ const {r,g,b}=hexToRgb(hex||'#999'); const yiq=(r*299+g*587+b*114)/1000; return yiq>=128?'#000':'#fff'; };

  // utoljára használt munkahely kulcsa
  const lastKey = ()=> currentUID ? `dent_last_place_${currentUID}` : 'dent_last_place';

  function setSelectBG(placeName){
    const color = (placeName===settings.w1name) ? settings.w1color :
                  (placeName===settings.w2name) ? settings.w2color : '#ffffff';
    workplaceEl.style.background = color;
    workplaceEl.style.color = contrast(color);
    workplaceEl.style.borderColor = color;
  }

  // színes opciók már a legördülőben is
  function makeColoredOption(name, color){
    const opt = document.createElement('option');
    opt.textContent = `● ${name}`;
    opt.value = name;
    opt.style.background = color;
    opt.style.color = contrast(color);
    opt.style.fontWeight = '600';
    return opt;
  }

  function bindWorkplaceOptions(){
    workplaceEl.innerHTML = '';
    const opts = [
      {name: settings.w1name, color: settings.w1color},
      {name: settings.w2name, color: settings.w2color}
    ];
    opts.forEach(({name,color})=> workplaceEl.appendChild(makeColoredOption(name,color)));

    const last = localStorage.getItem(lastKey());
    if(last){
      const idx = Array.from(workplaceEl.options).findIndex(o=>o.value===last);
      workplaceEl.selectedIndex = idx>=0 ? idx : 0;
    }else{
      workplaceEl.selectedIndex = 0;
    }
    setSelectBG(workplaceEl.value);
  }

  workplaceEl?.addEventListener('change', ()=>{
    setSelectBG(workplaceEl.value);
    if(currentUID) localStorage.setItem(lastKey(), workplaceEl.value);
  });

  function appendProcedureText(txt){
    const cur = (procedureEl.value || '').trim();
    if(!cur) procedureEl.value = txt;
    else {
      const sep = cur.endsWith(',') ? ' ' : ', ';
      procedureEl.value = cur + sep + txt;
    }
    procedureEl.dispatchEvent(new Event('input'));
  }

  function renderQuickProcedures(){
    quickWrap.innerHTML = '';
    (settings.procedures || []).forEach(name=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'chip-btn';
      b.textContent = name;
      b.addEventListener('click', ()=> appendProcedureText(name));
      quickWrap.appendChild(b);
    });
    if((settings.procedures||[]).length===0){
      const span = document.createElement('span');
      span.className='muted';
      span.textContent='(A gyors beavatkozások itt fognak megjelenni. Add hozzá őket a Beállítások oldalon.)';
      quickWrap.appendChild(span);
    }
  }

  function uiAuth(isLogged, user){
    if(isLogged){
      authCard.classList.add('hide');
      appContent.classList.remove('hide');
      userBox.textContent = user.email;
      dateEl.value = new Date().toISOString().slice(0,10);
      loadSettingsAndBindWorkplaces().finally(hideLoader);
      patientEl.focus();
    }else{
      authCard.classList.remove('hide');
      appContent.classList.add('hide');
      userBox.textContent = '';
      hideLoader();
    }
  }

  loginBtn.onclick = async ()=>{
    authMsg.textContent = '';
    try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); showLoader(); }
    catch(e){ authMsg.textContent = e.message || 'Belépési hiba'; }
  };
  registerBtn.onclick = async ()=>{
    authMsg.textContent = '';
    try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); showLoader(); }
    catch(e){ authMsg.textContent = e.message || 'Regisztrációs hiba'; }
  };
  logoutBtn.onclick = ()=>{ showLoader(); signOut(auth); };

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ uiAuth(false); return; }
    currentUID = user.uid;
    uiAuth(true, user);
    // ha nincs settings, hozzuk létre (alap színekkel is)
    const sRef = doc(db,'users',currentUID,'meta','settings');
    const snap = await getDoc(sRef);
    if(!snap.exists()){
      await setDoc(sRef, settings);
    }
  });

  async function loadSettingsAndBindWorkplaces(){
    const sRef = doc(db,'users',currentUID,'meta','settings');
    const snap = await getDoc(sRef);
    if(snap.exists()){
      const s = snap.data();
      settings.w1name  = s.w1name  ?? settings.w1name;
      settings.w2name  = s.w2name  ?? settings.w2name;
      settings.w1pct   = s.w1pct   ?? settings.w1pct;
      settings.w2pct   = s.w2pct   ?? settings.w2pct;
      settings.w1color = s.w1color ?? settings.w1color;
      settings.w2color = s.w2color ?? settings.w2color;
      settings.procedures = Array.isArray(s.procedures) ? s.procedures : [];
    }
    bindWorkplaceOptions();
    renderQuickProcedures();
  }

  function clearForm(){
    patientEl.value=''; procedureEl.value=''; amountEl.value='';
    dateEl.value = new Date().toISOString().slice(0,10);

    const last = localStorage.getItem(lastKey());
    if(last){
      const idx = Array.from(workplaceEl.options).findIndex(o=>o.value===last);
      workplaceEl.selectedIndex = idx>=0 ? idx : 0;
    }else{
      workplaceEl.selectedIndex = 0;
    }
    setSelectBG(workplaceEl.value);

    patientEl.focus();
  }
  resetBtn.onclick = clearForm;

  saveBtn.onclick = async ()=>{
    saveOk.classList.add('hide');
    saveErr.classList.add('hide');
    saveErr.textContent = '';

    const payload = {
      date: dateEl.value,
      patient: (patientEl.value||'').trim(),
      procedure: (procedureEl.value||'').trim(),
      amount: Math.max(0, Math.round(+amountEl.value||0)),
      workplace: workplaceEl.value || null,
      pctAtSave: null,
      ownAtSave: null,
      createdAt: Date.now()
    };

    if(!payload.date || !payload.patient || !payload.procedure || !payload.amount || !payload.workplace){
      saveErr.textContent = 'Dátum, páciens, beavatkozás, összeg és munkahely kötelező.';
      saveErr.classList.remove('hide');
      return;
    }

    saveBtn.disabled = true;
    try{
      await addDoc(collection(db,'users',currentUID,'entries'), payload);
      localStorage.setItem(lastKey(), payload.workplace);

      saveOk.classList.remove('hide');
      setTimeout(()=>saveOk.classList.add('hide'), 2000);
      clearForm();
    }catch(err){
      saveErr.textContent = err?.message || 'Mentési hiba.';
      saveErr.classList.remove('hide');
    }finally{
      saveBtn.disabled = false;
    }
  };
</script>
</body>
</html>
