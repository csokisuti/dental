<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="apple-touch-icon" href="dent.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Bevételkövető">
<meta name="theme-color" content="#2563eb">
<title>Fogorvosi bevételkövető – Rögzítés</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e6eaf1;--primary:#2563eb;--danger:#ef4444;--ok:#16a34a;--shadow:0 6px 25px rgba(15,23,42,.08)}
  *{box-sizing:border-box}
  html,body{height:100%}
  html{-webkit-text-size-adjust:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
  .hide{display:none !important}
  .layout{max-width:700px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:16px}
  h1{font-size:20px;margin:0 0 8px}
  h2{font-size:16px;margin:0 0 10px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:16px;appearance:none;-webkit-appearance:none}
  select{background-image:linear-gradient(45deg,transparent 50%,#94a3b8 50%),linear-gradient(135deg,#94a3b8 50%,transparent 50%),linear-gradient(to right,transparent,transparent);background-position:calc(100% - 16px) 50%,calc(100% - 12px) 50%,0 0;background-size:6px 6px,6px 6px,100% 100%;background-repeat:no-repeat;padding-right:36px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .toolbar{display:flex;gap:10px;justify-content:flex-end;align-items:center;margin-top:12px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:12px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;text-decoration:none;color:inherit;font-size:16px;min-height:44px;touch-action:manipulation}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn.link{background:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .alert{padding:10px 12px;border-radius:10px;font-weight:600}
  .alert.ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}
  .alert.err{background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .quick-wrap{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px}
  .chip-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer;font-weight:600;font-size:14px;min-height:36px}
  .chip-btn:hover{box-shadow:0 2px 10px rgba(15,23,42,.08)}
  .loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:9999;transition:opacity .25s ease;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
  .loader.hide{opacity:0;pointer-events:none}
  .loader-inner{display:flex;flex-direction:column;align-items:center;gap:12px}
  .tooth{width:64px;height:64px}
  .spin{animation:spin 1.1s linear infinite}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .loader-text{color:var(--muted);font-weight:600}
  @media (max-width:480px){.row{grid-template-columns:1fr}.layout{padding:16px}.btn{width:100%}}
</style>
</head>
<body>
<div id="loader" class="loader">
  <div class="loader-inner">
    <svg class="tooth spin" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Betöltés">
      <path d="M20 8c-6 0-10 5-10 12 0 9 5 14 9 17 4 3 5 15 9 15s5-9 9-9 5 9 9 9 5-12 9-15c4-3 9-8 9-17 0-7-4-12-10-12-5 0-9 2-12 5-3-3-7-5-12-5z" stroke="#2563eb" stroke-width="2" fill="#fff"/>
      <circle cx="26" cy="24" r="2.5" fill="#0f172a"/>
      <circle cx="38" cy="24" r="2.5" fill="#0f172a"/>
      <path d="M24 33c2 3 6 5 8 5s6-2 8-5" stroke="#0f172a" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <div class="loader-text">Betöltés…</div>
  </div>
</div>

<div class="layout hide" id="root">
  <div class="topbar">
    <h1>Fogorvosi bevételkövető – Rögzítés</h1>
    <div class="nav">
      <a class="btn link" href="settings.html">Beállítások</a>
      <a class="btn link" href="income.html">Bevételek</a>
      <button class="btn" id="logoutBtn">Kijelentkezés</button>
    </div>
  </div>

  <div class="card" id="authCard">
    <h2>Bejelentkezés</h2>
    <div class="row">
      <div><label>E-mail</label><input type="email" id="email" inputmode="email" autocomplete="username"></div>
      <div><label>Jelszó</label><input type="password" id="password" autocomplete="current-password"></div>
    </div>
    <div class="toolbar">
      <button class="btn primary" id="loginBtn">Belépés</button>
      <button class="btn" id="registerBtn">Regisztráció</button>
    </div>
    <div class="muted" id="authMsg"></div>
  </div>

  <div id="appContent" class="card hide">
    <div class="topbar"><h2>Új bejegyzés</h2></div>

    <div id="saveOk" class="alert ok hide">Sikeresen mentve ✓</div>
    <div id="saveErr" class="alert err hide"></div>

    <div class="row">
      <div><label>Dátum</label><input type="date" id="date"></div>
      <div><label>Páciens neve</label><input type="text" id="patient" placeholder="Pl. Kiss Anna" autocomplete="name"></div>
    </div>

    <div>
      <label>Beavatkozás</label>
      <input type="text" id="procedure" placeholder="Pl. tömés, gyökérkezelés…">
      <div id="quickProcedures" class="quick-wrap"></div>
    </div>

    <div class="row">
      <div><label>Fizetett összeg (HUF)</label><input type="number" id="amount" min="0" step="1" inputmode="numeric" placeholder="pl. 25000"></div>
      <div><label>Munkahely</label><select id="workplace"></select></div>
    </div>

    <div class="toolbar">
      <button class="btn" id="resetBtn">Mezők törlése</button>
      <button class="btn primary" id="saveBtn">Mentés</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, getDoc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyBGVBozEiKhqOqvvYB9Qsm1xCLrsw0itNI",
    authDomain:"dental-38375.firebaseapp.com",
    projectId:"dental-38375",
    storageBucket:"dental-38375.appspot.com",
    messagingSenderId:"245424156358",
    appId:"1:245424156358:web:e6426588b20675756331c7",
    measurementId:"G-WC90WMHRZT"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const root = document.getElementById('root');
  const loader = document.getElementById('loader');
  const authCard = document.getElementById('authCard');
  const appContent = document.getElementById('appContent');
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authMsg = document.getElementById('authMsg');

  const dateEl = document.getElementById('date');
  const patientEl = document.getElementById('patient');
  const procedureEl = document.getElementById('procedure');
  const quickWrap = document.getElementById('quickProcedures');
  const amountEl = document.getElementById('amount');
  const workplaceEl = document.getElementById('workplace');
  const resetBtn = document.getElementById('resetBtn');
  const saveBtn = document.getElementById('saveBtn');

  const saveOk = document.getElementById('saveOk');
  const saveErr = document.getElementById('saveErr');

  let currentUID = null;
  let settings = {
    w1name:'Hely1', w1pct:0.30, w1color:'#2563eb',
    w2name:'Hely2', w2pct:0.40, w2color:'#16a34a',
    proceduresByPlace:{ w1:[], w2:[] }
  };

  const hideLoader = ()=> loader.classList.add('hide');
  const showLoader = ()=> loader.classList.remove('hide');
  const hexToRgb = (hex)=>{ const h=hex.replace('#',''); const b=parseInt(h.length===3?h.split('').map(x=>x+x).join(''):h,16); return {r:(b>>16)&255,g:(b>>8)&255,b:b&255}; };
  const contrast = (hex)=>{ const {r,g,b}=hexToRgb(hex||'#999'); const yiq=(r*299+g*587+b*114)/1000; return yiq>=128?'#000':'#fff'; };
  const lastKey = ()=> currentUID ? `dent_last_place_${currentUID}` : 'dent_last_place';
  const monthKey = d => { const dt=new Date(d); return isNaN(dt)?'':dt.toISOString().slice(0,7); };

  function setSelectBG(placeName){
    const color = (placeName===settings.w1name) ? settings.w1color :
                  (placeName===settings.w2name) ? settings.w2color : '#ffffff';
    workplaceEl.style.background = color;
    workplaceEl.style.color = contrast(color);
    workplaceEl.style.borderColor = color;
  }
  function makeColoredOption(name, color){
    const opt = document.createElement('option');
    opt.textContent = `● ${name}`; opt.value = name;
    opt.style.background = color; opt.style.color = contrast(color); opt.style.fontWeight='600';
    return opt;
  }
  function bindWorkplaceOptions(){
    workplaceEl.innerHTML = '';
    [{name:settings.w1name,color:settings.w1color},{name:settings.w2name,color:settings.w2color}]
      .forEach(({name,color})=> workplaceEl.appendChild(makeColoredOption(name,color)));
    const last = localStorage.getItem(lastKey());
    if(last){
      const idx = Array.from(workplaceEl.options).findIndex(o=>o.value===last);
      workplaceEl.selectedIndex = idx>=0 ? idx : 0;
    }else workplaceEl.selectedIndex = 0;
    setSelectBG(workplaceEl.value);
  }

  function currentSlot(){
    const v = workplaceEl.value;
    if(v===settings.w1name) return 'w1';
    if(v===settings.w2name) return 'w2';
    return 'w1';
  }

  function appendProcedureText(txt){
    const cur = (procedureEl.value || '').trim();
    procedureEl.value = cur ? (cur + (cur.endsWith(',')?' ':', ') + txt) : txt;
    procedureEl.dispatchEvent(new Event('input'));
  }

  function renderQuickProcedures(){
    quickWrap.innerHTML = '';
    const slot = currentSlot();
    const list = (settings.proceduresByPlace && Array.isArray(settings.proceduresByPlace[slot]))
      ? settings.proceduresByPlace[slot] : [];
    list.forEach(name=>{
      const b=document.createElement('button');
      b.type='button'; b.className='chip-btn'; b.textContent=name;
      b.addEventListener('click',()=>appendProcedureText(name));
      quickWrap.appendChild(b);
    });
    if(list.length===0){
      const s=document.createElement('span'); s.className='muted';
      s.textContent='(Itt jelennek meg a gyors beavatkozások. Add hozzá őket a Beállításokban a kiválasztott helyhez.)';
      quickWrap.appendChild(s);
    }
  }

  workplaceEl.addEventListener('change', ()=>{
    setSelectBG(workplaceEl.value);
    if(currentUID) localStorage.setItem(lastKey(), workplaceEl.value);
    renderQuickProcedures();
  });

  function showAuth(){ authCard.classList.remove('hide'); appContent.classList.add('hide'); }
  function showApp(){ authCard.classList.add('hide'); appContent.classList.remove('hide'); }
  function uiAuth(isLogged, user){
    document.getElementById('root').classList.remove('hide');
    if(isLogged){
      showApp();
      dateEl.value=new Date().toISOString().slice(0,10);
      loadSettingsAndBindWorkplaces().finally(hideLoader);
      patientEl.focus();
    } else { showAuth(); hideLoader(); }
  }
  const tryLogin = async (fn)=>{ authMsg.textContent=''; try{ await fn(); showLoader(); }catch(e){ authMsg.textContent=e?.message || 'Hiba'; } };
  loginBtn.onclick = ()=> tryLogin(()=>signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value));
  registerBtn.onclick = ()=> tryLogin(()=>createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value));
  logoutBtn.onclick = ()=>{ showLoader(); signOut(auth); };

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ currentUID=null; uiAuth(false); return; }
    currentUID = user.uid;
    const sRef = doc(db,'users',currentUID,'meta','settings');
    const snap = await getDoc(sRef);
    if(!snap.exists()){
      await setDoc(sRef, settings);
    }
    uiAuth(true, user);
  });

  async function loadSettingsAndBindWorkplaces(){
    const sRef = doc(db,'users',currentUID,'meta','settings');
    const snap = await getDoc(sRef);
    if(snap.exists()){
      const s = snap.data();
      const legacy = Array.isArray(s.procedures) ? s.procedures : [];
      const pbp = s.proceduresByPlace && typeof s.proceduresByPlace==='object'
        ? { w1: Array.isArray(s.proceduresByPlace.w1)? s.proceduresByPlace.w1 : [],
            w2: Array.isArray(s.proceduresByPlace.w2)? s.proceduresByPlace.w2 : [] }
        : { w1: legacy, w2: legacy };
      settings = {
        ...settings,
        w1name: s.w1name ?? settings.w1name,
        w2name: s.w2name ?? settings.w2name,
        w1pct: s.w1pct ?? settings.w1pct,
        w2pct: s.w2pct ?? settings.w2pct,
        w1color: s.w1color ?? settings.w1color,
        w2color: s.w2color ?? settings.w2color,
        proceduresByPlace: pbp
      };
    }
    bindWorkplaceOptions();
    renderQuickProcedures();
  }

  function clearForm(){
    patientEl.value=''; procedureEl.value=''; amountEl.value='';
    dateEl.value = new Date().toISOString().slice(0,10);
    const last = localStorage.getItem(lastKey());
    if(last){
      const idx = Array.from(workplaceEl.options).findIndex(o=>o.value===last);
      workplaceEl.selectedIndex = idx>=0 ? idx : 0;
    }else workplaceEl.selectedIndex = 0;
    setSelectBG(workplaceEl.value);
    renderQuickProcedures();
    patientEl.focus();
  }
  resetBtn.onclick = clearForm;

  async function nextMonthlySeq(uid, month){
    const counterRef = doc(db,'users',uid,'counters',month);
    const seq = await runTransaction(db, async (tx)=>{
      const snap = await tx.get(counterRef);
      const cur = snap.exists()? (snap.data().lastSeq||0) : 0;
      const next = cur + 1;
      tx.set(counterRef, { lastSeq: next }, { merge:true });
      return next;
    });
    return seq;
  }

  // === Kis-/nagybetűtől független kezelés
  function normalizeProcName(s){
    return (s||'')
      .trim()
      .replace(/\s+/g,' ')
      .toLocaleLowerCase('hu-HU');
  }

  // Segédfüggvény – beavatkozások szétvágása vessző szerint + case-insensitive egyedisítés
  function splitProcedures(text){
    const items = (text||'')
      .split(',')
      .map(s=>s.trim())
      .filter(Boolean);
    const seen = new Set();
    const out = [];
    for(const it of items){
      const k = normalizeProcName(it);
      if(!seen.has(k)){ seen.add(k); out.push(it); }
    }
    return out;
  }

  // Ha új beavatkozás(oka)t írt be, ajánljuk fel a gyorslistához adást (case-insensitive)
  async function maybeAddNewProceduresToSettings(procText){
    const items = splitProcedures(procText);
    const slot = currentSlot();

    const existing = (settings.proceduresByPlace?.[slot]) || [];
    const existingMap = new Map(existing.map(orig => [normalizeProcName(orig), orig]));

    const missing = items.filter(x => !existingMap.has(normalizeProcName(x)));
    if(missing.length===0) return false;

    const placeName = slot==='w1' ? (settings.w1name||'Hely1') : (settings.w2name||'Hely2');
    const ok = confirm(
      `A következő új beavatkozás(ok) nincsenek a(z) "${placeName}" gyorslistájában:\n\n`+
      missing.map(m=>`• ${m}`).join('\n')+
      `\n\nHozzáadjam most?`
    );
    if(!ok) return false;

    // frissített slot lista (az általad írt eredeti formával bővítünk)
    const updated = existing.slice();
    const updatedSeen = new Set(existing.map(normalizeProcName));
    for(const m of missing){
      const key = normalizeProcName(m);
      if(!updatedSeen.has(key)){
        updated.push(m);
        updatedSeen.add(key);
      }
    }
    const updatedSlotList = updated.slice(0,100);

    // kompatibilitási 'procedures' mező összevonása case-insensitive módon
    const allForCompat = [...(settings.proceduresByPlace?.w1||[]), ...(settings.proceduresByPlace?.w2||[]), ...missing];
    const compatSeen = new Set();
    const mergedProcedures = [];
    for(const p of allForCompat){
      const k = normalizeProcName(p);
      if(!compatSeen.has(k)){
        compatSeen.add(k);
        mergedProcedures.push(p);
      }
    }

    await setDoc(
      doc(db,'users',currentUID,'meta','settings'),
      {
        proceduresByPlace: {
          ...(settings.proceduresByPlace||{w1:[],w2:[]}),
          [slot]: updatedSlotList
        },
        procedures: mergedProcedures.slice(0,200)
      },
      { merge:true }
    );

    // helyi állapot + UI frissítés
    settings.proceduresByPlace = {
      ...(settings.proceduresByPlace||{w1:[],w2:[]}),
      [slot]: updatedSlotList
    };
    renderQuickProcedures();
    return true;
  }

  saveBtn.onclick = async ()=>{
    saveOk.classList.add('hide'); saveErr.classList.add('hide'); saveErr.textContent = '';
    const payload = {
      date: dateEl.value,
      patient: (patientEl.value||'').trim(),
      procedure: (procedureEl.value||'').trim(),
      amount: Math.max(0, Math.round(+amountEl.value||0)),
      workplace: workplaceEl.value || null,
      pctAtSave: null,
      ownAtSave: null,
      createdAt: Date.now()
    };
    if(!payload.date || !payload.patient || !payload.procedure || !payload.amount || !payload.workplace){
      saveErr.textContent = 'Dátum, páciens, beavatkozás, összeg és munkahely kötelező.'; saveErr.classList.remove('hide'); return;
    }
    const mKey = monthKey(payload.date);
    if(!mKey){ saveErr.textContent='Érvénytelen dátum.'; saveErr.classList.remove('hide'); return; }

    saveBtn.disabled = true;
    try{
      // mentés előtt felajánljuk a hiányzók gyorslistához adását (kis-/nagybetű független)
      await maybeAddNewProceduresToSettings(payload.procedure);

      const seq = await nextMonthlySeq(currentUID, mKey);
      await addDoc(collection(db,'users',currentUID,'entries'), { ...payload, monthKey: mKey, seq });
      localStorage.setItem(lastKey(), payload.workplace);
      saveOk.classList.remove('hide'); setTimeout(()=>saveOk.classList.add('hide'), 2000);
      clearForm();
    }catch(err){
      saveErr.textContent = err?.message || 'Mentési hiba.'; saveErr.classList.remove('hide');
    }finally{ saveBtn.disabled = false; }
  };
</script>
</body>
</html>
