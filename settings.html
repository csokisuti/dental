<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<link rel="apple-touch-icon" href="dent.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Bevételkövető">
<meta name="theme-color" content="#2563eb">

<title>Beállítások – Fogorvosi bevételkövető</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e6eaf1;--primary:#2563eb;--shadow:0 6px 25px rgba(15,23,42,.08)}
  *{box-sizing:border-box}
  html,body{height:100%}
  html{-webkit-text-size-adjust:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    padding: env(safe-area-inset-top) env(safe-area-inset-right)
             env(safe-area-inset-bottom) env(safe-area-inset-left);
  }
  .layout{max-width:800px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:16px}
  h1{margin:0 0 6px;font-size:20px}
  h2{margin:0 0 10px;font-size:16px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input,.row input,.row select{
    width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;
    font-size:16px;appearance:none;-webkit-appearance:none;
  }
  .row select{
    background-image: linear-gradient(45deg, transparent 50%, #94a3b8 50%),
                      linear-gradient(135deg, #94a3b8 50%, transparent 50%),
                      linear-gradient(to right, transparent, transparent);
    background-position: calc(100% - 16px) 50%, calc(100% - 12px) 50%, 0 0;
    background-size: 6px 6px, 6px 6px, 100% 100%;
    background-repeat: no-repeat;
    padding-right:36px;
  }
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{
    display:inline-flex;align-items:center;gap:6px;padding:12px 14px;border:1px solid var(--line);
    border-radius:10px;background:#fff;cursor:pointer;text-decoration:none;color:inherit;
    font-size:16px;min-height:44px;touch-action:manipulation;
  }
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .muted{color:var(--muted);font-size:12px}
  .pill{display:inline-block;padding:6px 12px;border-radius:999px;border:1px solid var(--line);font-weight:600}
  .hide{display:none !important}
  .ok{padding:10px;border-radius:10px;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}
  .err{padding:10px;border-radius:10px;background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}

  /* Gyors beavatkozások szerkesztése */
  .chip-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-weight:600;
    user-select:none
  }
  .chip .mini{font-size:12px;opacity:.8;cursor:pointer}
  .chip .mini:hover{opacity:1;text-decoration:underline}
  .chip .drag{cursor:grab;opacity:.7}
  .chip.dragging{opacity:.5}
  .chip .mv{display:inline-flex;gap:4px}
  .chip .mv button{padding:2px 8px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:12px}

  /* Hely-választó (Hely1 / Hely2) */
  .place-switch{
    display:inline-flex;border:1px solid var(--line);border-radius:12px;overflow:hidden;
  }
  .place-switch button{
    padding:8px 12px;border:0;background:#fff;cursor:pointer;font-weight:700
  }
  .place-switch button.active{
    background:var(--primary);color:#fff
  }

  /* Loader */
  .loader{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:var(--bg);z-index:9999;transition:opacity .25s ease;
    padding: env(safe-area-inset-top) env(safe-area-inset-right)
             env(safe-area-inset-bottom) env(safe-area-inset-left);
  }
  .loader.hide{opacity:0;pointer-events:none}
  .loader-inner{display:flex;flex-direction:column;align-items:center;gap:12px}
  .tooth{width:64px;height:64px}
  .loader-text{color:var(--muted);font-weight:600}

  @media (max-width:640px){
    .layout{padding:16px}
    .row{grid-template-columns:1fr}
    .row3{grid-template-columns:1fr}
    .btn{width:100%}
    .place-switch{width:100%}
    .place-switch button{flex:1}
  }
</style>
</head>
<body>
<div id="loader" class="loader">
  <div class="loader-inner">
    <svg class="tooth" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Betöltés">
      <path d="M20 8c-6 0-10 5-10 12 0 9 5 14 9 17 4 3 5 15 9 15s5-9 9-9 5 9 9 9 5-12 9-15c4-3 9-8 9-17 0-7-4-12-10-12-5 0-9 2-12 5-3-3-7-5-12-5z" stroke="#2563eb" stroke-width="2" fill="#fff"/>
      <circle cx="26" cy="24" r="2.5" fill="#0f172a"/>
      <circle cx="38" cy="24" r="2.5" fill="#0f172a"/>
      <path d="M24 33c2 3 6 5 8 5s6-2 8-5" stroke="#0f172a" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <div class="loader-text">Betöltés…</div>
  </div>
</div>

<div class="layout">
  <div class="topbar">
    <h1>Beállítások</h1>
    <div class="nav">
      <a class="btn" href="index.html">Rögzítés</a>
      <a class="btn" href="income.html">Bevételek</a>
      <button class="btn" id="logoutBtn">Kijelentkezés</button>
    </div>
  </div>

  <div class="card" id="authCard">
    <div class="row">
      <div>
        <label>E-mail</label>
        <input type="email" id="email" inputmode="email" autocomplete="username">
      </div>
      <div>
        <label>Jelszó</label>
        <input type="password" id="password" autocomplete="current-password">
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="loginBtn">Belépés</button>
      <button class="btn" id="registerBtn">Regisztráció</button>
    </div>
    <div class="muted" id="authMsg"></div>
  </div>

  <div class="card hide" id="content">
    <h2>Helyek</h2>
    <div id="msgOk" class="ok hide">Mentve ✓</div>
    <div id="msgErr" class="err hide"></div>

    <div class="row3">
      <div>
        <label>Hely 1 neve</label>
        <input id="w1name" placeholder="Pl. Rendelő A">
      </div>
      <div>
        <label>Hely 1 – Saját % (0–1)</label>
        <input id="w1pct" type="number" min="0" max="1" step="0.01" placeholder="0.30">
      </div>
      <div>
        <label>Hely 1 – Szín</label>
        <input id="w1color" type="color" value="#2563eb">
      </div>
    </div>

    <div class="row3" style="margin-top:10px">
      <div>
        <label>Hely 2 neve</label>
        <input id="w2name" placeholder="Pl. Rendelő B">
      </div>
      <div>
        <label>Hely 2 – Saját % (0–1)</label>
        <input id="w2pct" type="number" min="0" max="1" step="0.01" placeholder="0.40">
      </div>
      <div>
        <label>Hely 2 – Szín</label>
        <input id="w2color" type="color" value="#16a34a">
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin:14px 0">
      <span class="muted">Előnézet:</span>
      <span id="p1" class="pill">Hely1</span>
      <span id="p2" class="pill">Hely2</span>
    </div>

    <hr style="border:none;border-top:1px solid var(--line);margin:16px 0">

    <h2>Gyors beavatkozások</h2>

    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <div class="place-switch" id="placeSwitch">
        <button type="button" id="tabW1" class="active">Hely1</button>
        <button type="button" id="tabW2">Hely2</button>
      </div>
      <span class="muted">Munkahelyenként külön listát állíthatsz be.</span>
    </div>

    <div class="row">
      <div>
        <label>Megnevezés</label>
        <input id="procInput" placeholder="Pl. Tömések, Gyökérkezelés, Fogkőeltávolítás">
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap">
        <button class="btn" id="procAddBtn">Hozzáadás</button>
        <button class="btn" id="procSaveEditBtn" style="display:none">Szerkesztés mentése</button>
        <button class="btn" id="procCancelEditBtn" style="display:none">Mégse</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">
      Tipp: vesszővel elválasztva több elemet is hozzáadhatsz egyszerre. Fogd-és-vidd módszerrel vagy a ◀︎/▶︎ nyilakkal módosíthatod a sorrendet.
    </div>
    <div id="procList" class="chip-list"></div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap">
      <button class="btn primary" id="saveBtn">Beállítások mentése</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGVBozEiKhqOqvvYB9Qsm1xCLrsw0itNI",
    authDomain: "dental-38375.firebaseapp.com",
    projectId: "dental-38375",
    storageBucket: "dental-38375.appspot.com",
    messagingSenderId: "245424156358",
    appId: "1:245424156358:web:e6426588b20675756331c7",
    measurementId: "G-WC90WMHRZT"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loader = document.getElementById('loader');
  const hideLoader = ()=> loader.classList.add('hide');
  const showLoader = ()=> loader.classList.remove('hide');

  const authCard = document.getElementById('authCard');
  const content = document.getElementById('content');
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authMsg = document.getElementById('authMsg');

  const w1name = document.getElementById('w1name');
  const w1pct  = document.getElementById('w1pct');
  const w1color= document.getElementById('w1color');
  const w2name = document.getElementById('w2name');
  const w2pct  = document.getElementById('w2pct');
  const w2color= document.getElementById('w2color');
  const p1 = document.getElementById('p1');
  const p2 = document.getElementById('p2');
  const saveBtn = document.getElementById('saveBtn');
  const msgOk = document.getElementById('msgOk');
  const msgErr = document.getElementById('msgErr');

  const procInput = document.getElementById('procInput');
  const procAddBtn = document.getElementById('procAddBtn');
  const procSaveEditBtn = document.getElementById('procSaveEditBtn');
  const procCancelEditBtn = document.getElementById('procCancelEditBtn');
  const procList = document.getElementById('procList');

  const tabW1 = document.getElementById('tabW1');
  const tabW2 = document.getElementById('tabW2');

  let uid = null;
  let procsByPlace = { w1: [], w2: [] };
  let editingIndex = -1;
  let dragIndex = -1;
  let activeSlot = 'w1';

  const applyPreview = ()=>{
    tabW1.textContent = w1name.value?.trim() || 'Hely1';
    tabW2.textContent = w2name.value?.trim() || 'Hely2';

    p1.textContent = w1name.value?.trim() || 'Hely1';
    p1.style.background = w1color.value || '#2563eb'; p1.style.color = '#fff';

    p2.textContent = w2name.value?.trim() || 'Hely2';
    p2.style.background = w2color.value || '#16a34a'; p2.style.color = '#fff';
  };
  [w1name,w2name,w1color,w2color].forEach(el=>el.addEventListener('input', applyPreview));

  function setActive(slot){
    activeSlot = slot;
    if(slot==='w1'){ tabW1.classList.add('active'); tabW2.classList.remove('active'); }
    else { tabW1.classList.remove('active'); tabW2.classList.add('active'); }
    // szerkesztési mód törlése váltáskor
    editingIndex = -1;
    procInput.value = '';
    procAddBtn.style.display='';
    procSaveEditBtn.style.display='none';
    procCancelEditBtn.style.display='none';
    renderProcedures();
  }
  tabW1.onclick = ()=> setActive('w1');
  tabW2.onclick = ()=> setActive('w2');

  function moveItem(arr, from, to){
    if(from===to || from<0 || to<0 || from>=arr.length || to>=arr.length) return arr;
    const item = arr.splice(from,1)[0];
    arr.splice(to,0,item);
    return arr;
  }

  function renderProcedures(){
    procList.innerHTML = '';
    const list = procsByPlace[activeSlot] || [];
    if(list.length===0){
      const span = document.createElement('span');
      span.className='muted';
      span.textContent='Nincs még gyors beavatkozás ezen a helyen. Adj hozzá fent!';
      procList.appendChild(span);
      return;
    }
    list.forEach((name, idx)=>{
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.setAttribute('draggable','true');
      chip.dataset.index = idx;

      const drag = document.createElement('span');
      drag.className='mini drag';
      drag.textContent='⠿';
      drag.title='Fogd meg és húzd új helyre';

      const text = document.createElement('span');
      text.textContent = name;

      const mv = document.createElement('span');
      mv.className='mv';
      const left = document.createElement('button');
      left.type='button'; left.textContent='◀︎'; left.title='Balra';
      left.onclick = ()=>{ moveItem(list, idx, Math.max(0,idx-1)); renderProcedures(); };

      const right = document.createElement('button');
      right.type='button'; right.textContent='▶︎'; right.title='Jobbra';
      right.onclick = ()=>{ moveItem(list, idx, Math.min(list.length-1,idx+1)); renderProcedures(); };
      mv.appendChild(left); mv.appendChild(right);

      const edit = document.createElement('span');
      edit.className='mini'; edit.textContent='✎'; edit.title='Szerkesztés';
      edit.onclick = ()=>{
        editingIndex = idx;
        procInput.value = name;
        procAddBtn.style.display='none';
        procSaveEditBtn.style.display='';
        procCancelEditBtn.style.display='';
        procInput.focus();
      };

      const del = document.createElement('span');
      del.className='mini'; del.textContent='×'; del.title='Törlés';
      del.onclick = ()=>{
        list.splice(idx,1);
        renderProcedures();
      };

      chip.appendChild(drag);
      chip.appendChild(text);
      chip.appendChild(mv);
      chip.appendChild(edit);
      chip.appendChild(del);

      chip.addEventListener('dragstart', (e)=>{
        dragIndex = Number(chip.dataset.index);
        chip.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      chip.addEventListener('dragend', ()=>{
        dragIndex = -1;
        chip.classList.remove('dragging');
      });
      chip.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const overIndex = Number(chip.dataset.index);
        if(dragIndex!==-1 && overIndex!==dragIndex){
          moveItem(list, dragIndex, overIndex);
          dragIndex = overIndex;
          renderProcedures();
        }
      });

      procList.appendChild(chip);
    });
  }

  function addFromInput(){
    const raw = (procInput.value||'').trim();
    if(!raw) return;
    const target = procsByPlace[activeSlot] || [];
    raw.split(',').map(s=>s.trim()).filter(Boolean).forEach(item=>{
      if(!target.includes(item) && target.length<100) target.push(item);
    });
    procsByPlace[activeSlot] = target;
    procInput.value='';
    renderProcedures();
  }
  procAddBtn.onclick = addFromInput;

  procSaveEditBtn.onclick = ()=>{
    const val = (procInput.value||'').trim();
    const list = procsByPlace[activeSlot] || [];
    if(val && editingIndex>=0 && editingIndex<list.length){
      list[editingIndex] = val;
      procsByPlace[activeSlot] = list;
      editingIndex = -1;
      procInput.value='';
      procAddBtn.style.display='';
      procSaveEditBtn.style.display='none';
      procCancelEditBtn.style.display='none';
      renderProcedures();
    }
  };
  procCancelEditBtn.onclick = ()=>{
    editingIndex = -1;
    procInput.value='';
    procAddBtn.style.display='';
    procSaveEditBtn.style.display='none';
    procCancelEditBtn.style.display='none';
  };

  onAuthStateChanged(auth, async user=>{
    if(!user){
      authCard.classList.remove('hide');
      content.classList.add('hide');
      hideLoader();
      uid=null; return;
    }
    uid = user.uid;
    authCard.classList.add('hide');
    content.classList.remove('hide');

    const sRef = doc(db,'users',uid,'meta','settings');
    const snap = await getDoc(sRef);
    if(!snap.exists()){
      await setDoc(sRef,{
        w1name:'Hely1', w1pct:0.30, w1color:'#2563eb',
        w2name:'Hely2', w2pct:0.40, w2color:'#16a34a',
        proceduresByPlace:{ w1:[], w2:[] },
        procedures:[]
      });
    }
    const s = (await getDoc(sRef)).data() || {};
    w1name.value = s.w1name ?? 'Hely1';
    w1pct.value  = s.w1pct ?? 0.30;
    w1color.value= s.w1color ?? '#2563eb';
    w2name.value = s.w2name ?? 'Hely2';
    w2pct.value  = s.w2pct ?? 0.40;
    w2color.value= s.w2color ?? '#16a34a';

    // visszafelé kompatibilitás: ha nincs proceduresByPlace, örököljön a legacy 'procedures' listából
    const legacy = Array.isArray(s.procedures)? s.procedures : [];
    const pbp = (s.proceduresByPlace && typeof s.proceduresByPlace==='object')
      ? { w1: Array.isArray(s.proceduresByPlace.w1)? s.proceduresByPlace.w1 : [],
          w2: Array.isArray(s.proceduresByPlace.w2)? s.proceduresByPlace.w2 : [] }
      : { w1: legacy, w2: legacy };

    procsByPlace = { w1:[...pbp.w1].slice(0,100), w2:[...pbp.w2].slice(0,100) };

    applyPreview();
    setActive('w1'); // render is hívódik
    hideLoader();
  });

  loginBtn.onclick = async ()=>{ authMsg.textContent=''; try{ await signInWithEmailAndPassword(auth,emailEl.value.trim(),passEl.value); showLoader(); }catch(e){ authMsg.textContent = e.message; } };
  registerBtn.onclick = async ()=>{ authMsg.textContent=''; try{ await createUserWithEmailAndPassword(auth,emailEl.value.trim(),passEl.value); showLoader(); }catch(e){ authMsg.textContent = e.message; } };
  logoutBtn.onclick = ()=>{ showLoader(); signOut(auth); };

  saveBtn.onclick = async ()=>{
    msgOk.classList.add('hide'); msgErr.classList.add('hide');
    try{
      const data = {
        w1name: (w1name.value||'Hely1').trim(),
        w1pct: Math.max(0,Math.min(1,+w1pct.value||0.30)),
        w1color: w1color.value || '#2563eb',
        w2name: (w2name.value||'Hely2').trim(),
        w2pct: Math.max(0,Math.min(1,+w2pct.value||0.40)),
        w2color: w2color.value || '#16a34a',
        proceduresByPlace: {
          w1: (procsByPlace.w1||[]).slice(0,100),
          w2: (procsByPlace.w2||[]).slice(0,100)
        },
        // kompat: írunk egy egyesített 'procedures' mezőt is
        procedures: Array.from(new Set([...(procsByPlace.w1||[]), ...(procsByPlace.w2||[])])).slice(0,200)
      };
      await setDoc(doc(db,'users',uid,'meta','settings'), data, {merge:true});
      msgOk.classList.remove('hide');
      setTimeout(()=>msgOk.classList.add('hide'),1500);
    }catch(err){
      msgErr.textContent = err?.message || 'Mentési hiba';
      msgErr.classList.remove('hide');
    }
  };
</script>
</body>
</html>
