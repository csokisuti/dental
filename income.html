<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<link rel="apple-touch-icon" href="dent.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Bevételkövető">
<meta name="theme-color" content="#2563eb">

<title>Bevételek – Fogorvosi bevételkövető</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e6eaf1;--primary:#2563eb;--danger:#ef4444;--shadow:0 6px 25px rgba(15,23,42,.08)}
  *{box-sizing:border-box}
  html,body{height:100%}
  html{-webkit-text-size-adjust:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
  .layout{max-width:1100px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:16px}
  h1{margin:0 0 6px;font-size:20px}
  h2{margin:0 0 10px;font-size:16px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:16px;appearance:none;-webkit-appearance:none}
  select{background-image: linear-gradient(45deg, transparent 50%, #94a3b8 50%),linear-gradient(135deg, #94a3b8 50%, transparent 50%),linear-gradient(to right, transparent, transparent);background-position: calc(100% - 16px) 50%, calc(100% - 12px) 50%, 0 0;background-size: 6px 6px, 6px 6px, 100% 100%;background-repeat: no-repeat;padding-right:36px}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:12px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;text-decoration:none;color:inherit;font-size:16px;min-height:44px;touch-action:manipulation}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted);font-weight:600}
  .right{text-align:right}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;font-weight:600}
  .ktable{width:100%;overflow:auto;-webkit-overflow-scrolling:touch}
  .total{font-weight:700}
  .muted{color:var(--muted);font-size:12px}
  .hide{display:none !important}
  .ok{padding:8px 10px;border-radius:10px;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}
  .err{padding:8px 10px;border-radius:10px;background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}
  .loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:9999;transition:opacity .25s ease;padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
  .loader.hide{opacity:0;pointer-events:none}
  .loader-inner{display:flex;flex-direction:column;align-items:center;gap:12px}
  .tooth{width:64px;height:64px}
  .spin{animation:spin 1.1s linear infinite}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .loader-text{color:var(--muted);font-weight:600}
  @media (max-width: 640px){.layout{padding:16px}.row{grid-template-columns:1fr}.row2{grid-template-columns:1fr}.btn{width:100%}th,td{padding:8px}}
</style>
</head>
<body>
<div id="loader" class="loader">
  <div class="loader-inner">
    <svg class="tooth spin" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Betöltés">
      <path d="M20 8c-6 0-10 5-10 12 0 9 5 14 9 17 4 3 5 15 9 15s5-9 9-9 5 9 9 9 5-12 9-15c4-3 9-8 9-17 0-7-4-12-10-12-5 0-9 2-12 5-3-3-7-5-12-5z" stroke="#2563eb" stroke-width="2" fill="#fff"/>
      <circle cx="26" cy="24" r="2.5" fill="#0f172a"/>
      <circle cx="38" cy="24" r="2.5" fill="#0f172a"/>
      <path d="M24 33c2 3 6 5 8 5s6-2 8-5" stroke="#0f172a" stroke-width="2" stroke-linecap="round" />
    </svg>
    <div class="loader-text">Betöltés…</div>
  </div>
</div>

<div class="layout">
  <div class="topbar">
    <h1>Bevételek</h1>
    <div class="nav">
      <a class="btn" href="index.html">Rögzítés</a>
      <a class="btn" href="settings.html">Beállítások</a>
      <button class="btn" id="logoutBtn">Kijelentkezés</button>
    </div>
  </div>

  <div class="card" id="authCard">
    <div class="row2">
      <div>
        <label>E-mail</label>
        <input id="email" type="email" inputmode="email" autocomplete="username">
      </div>
      <div>
        <label>Jelszó</label>
        <input id="password" type="password" autocomplete="current-password">
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="loginBtn">Belépés</button>
      <button class="btn" id="registerBtn">Regisztráció</button>
    </div>
    <div class="muted" id="authMsg"></div>
  </div>

  <div class="card hide" id="filters">
    <h2>Szűrők</h2>
    <div class="row">
      <div>
        <label>Hónap</label>
        <input type="month" id="filterMonth">
      </div>
      <div>
        <label>Munkahely</label>
        <select id="filterWorkplace">
          <option value="">Összesen</option>
        </select>
      </div>
      <div>
        <label>Páciens</label>
        <input id="filterPatient" placeholder="Keresés névre">
      </div>
    </div>

    <!-- MIGRÁLÁS SZEKCIÓ -->
    <div style="margin-top:12px;border-top:1px solid var(--line);padding-top:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center">
      <strong>Migrálás (havi sorszámozás):</strong>
      <label style="display:inline-flex;gap:8px;align-items:center;font-size:14px">
        <input type="checkbox" id="migrateOnlyMissing" checked> Csak ahol hiányzik a sorszám
      </label>
      <button class="btn" id="migrateBtn">Havi sorszámozás lefuttatása</button>
      <span class="muted" id="migrateMsg"></span>
    </div>
  </div>

  <div class="card hide" id="editor">
    <h2>Szerkesztés</h2>
    <div id="editMsg" class="ok hide">Mentve ✓</div>
    <div id="editErr" class="err hide"></div>

    <div class="row">
      <div>
        <label>Dátum</label>
        <input id="editDate" type="date">
      </div>
      <div>
        <label>Páciens</label>
        <input id="editPatient">
      </div>
      <div>
        <label>Beavatkozás</label>
        <input id="editProcedure">
      </div>
    </div>
    <div class="row2" style="margin-top:10px">
      <div>
        <label>Összeg (HUF)</label>
        <input id="editAmount" type="number" min="0" step="1" inputmode="numeric">
      </div>
      <div>
        <label>Munkahely</label>
        <select id="editWorkplace"></select>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap">
      <button class="btn" id="cancelEdit">Mégse</button>
      <button class="btn primary" id="saveEdit">Mentés</button>
    </div>
  </div>

  <div class="card hide" id="listCard">
    <h2>Bejegyzések</h2>
    <div class="ktable">
      <table id="entriesTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Dátum</th>
            <th>Páciens</th>
            <th>Beavatkozás</th>
            <th>Munkahely</th>
            <th class="right">Fizetett</th>
            <th class="right">%-om</th>
            <th class="right">Saját</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td></td>
            <td colspan="3" class="right total">Összesen (szűrt):</td>
            <td class="right total" id="sumGross">0</td>
            <td></td>
            <td class="right total" id="sumOwn">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query, orderBy, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGVBozEiKhqOqvvYB9Qsm1xCLrsw0itNI",
    authDomain: "dental-38375.firebaseapp.com",
    projectId: "dental-38375",
    storageBucket: "dental-38375.appspot.com",
    messagingSenderId: "245424156358",
    appId: "1:245424156358:web:e6426588b20675756331c7",
    measurementId: "G-WC90WMHRZT"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loader = document.getElementById('loader');
  const showLoader = ()=> loader.classList.remove('hide');
  const hideLoader = ()=> loader.classList.add('hide');

  const authCard = document.getElementById('authCard');
  const filters = document.getElementById('filters');
  const listCard = document.getElementById('listCard');
  const editor = document.getElementById('editor');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const authMsg = document.getElementById('authMsg');

  const filterMonth = document.getElementById('filterMonth');
  const filterWorkplace = document.getElementById('filterWorkplace');
  const filterPatient = document.getElementById('filterPatient');

  const migrateBtn = document.getElementById('migrateBtn');
  const migrateOnlyMissing = document.getElementById('migrateOnlyMissing');
  const migrateMsg = document.getElementById('migrateMsg');

  const tableBody = document.querySelector('#entriesTable tbody');
  const sumGrossEl = document.getElementById('sumGross');
  const sumOwnEl = document.getElementById('sumOwn');

  const editDate = document.getElementById('editDate');
  const editPatient = document.getElementById('editPatient');
  const editProcedure = document.getElementById('editProcedure');
  const editAmount = document.getElementById('editAmount');
  const editWorkplace = document.getElementById('editWorkplace');
  const saveEdit = document.getElementById('saveEdit');
  const cancelEdit = document.getElementById('cancelEdit');
  const editMsg = document.getElementById('editMsg');
  const editErr = document.getElementById('editErr');

  let uid = null;
  let entries = [];
  let settings = { w1name:'Hely1', w1pct:0.30, w1color:'#2563eb', w2name:'Hely2', w2pct:0.40, w2color:'#16a34a' };
  let editingId = null;
  let editingOriginalMonthKey = null;

  const hexToRgb = (hex)=>{ const h = hex.replace('#',''); const b = parseInt(h.length===3? h.split('').map(x=>x+x).join(''):h,16); return {r:(b>>16)&255,g:(b>>8)&255,b:b&255}; };
  const contrast = (hex)=>{ const {r,g,b} = hexToRgb(hex||'#999'); const yiq=(r*299+g*587+b*114)/1000; return yiq>=128?'#000':'#fff'; };
  const fmt = n => (n||0).toLocaleString('hu-HU',{maximumFractionDigits:0});
  const monthKey = d => { const dt=new Date(d); return isNaN(dt)?'':dt.toISOString().slice(0,7); };
  function pctFor(place){ if(place===settings.w1name) return +settings.w1pct||0; if(place===settings.w2name) return +settings.w2pct||0; return 0; }

  function bindWorkplaceSelect(select, withAll=false){
    select.innerHTML = '';
    if(withAll){
      const all = document.createElement('option'); all.value=''; all.textContent='Összesen'; select.appendChild(all);
    }
    [settings.w1name, settings.w2name].forEach(n=>{
      const o=document.createElement('option'); o.value=n; o.textContent=n; select.appendChild(o);
    });
    if(withAll) select.selectedIndex = 0;
  }

  const updatedOnce = new Set();

  async function normalizeMissingCalculations(list){
    const ops = [];
    for(const e of list){
      const shouldHavePct = pctFor(e.workplace);
      const computedOwn = Math.round((+e.amount||0) * shouldHavePct);
      const missingPct = (e.pctAtSave == null);
      const missingOwn = (e.ownAtSave == null);
      const wrongOwn = (!missingOwn && e.ownAtSave !== computedOwn);

      const needMonthKey = !e.monthKey && e.date;
      if((missingPct || missingOwn || wrongOwn || needMonthKey) && !updatedOnce.has(e.id)){
        updatedOnce.add(e.id);
        const patch = {};
        if(missingPct) patch.pctAtSave = shouldHavePct;
        if(missingOwn || wrongOwn) patch.ownAtSave = computedOwn;
        if(needMonthKey) patch.monthKey = monthKey(e.date);
        ops.push(updateDoc(doc(db,'users',uid,'entries',e.id), patch).catch(()=>{}));
      }
    }
    if(ops.length) await Promise.all(ops);
  }

  onAuthStateChanged(auth, async user=>{
    if(!user){
      authCard.classList.remove('hide');
      filters.classList.add('hide');
      listCard.classList.add('hide');
      editor.classList.add('hide');
      hideLoader();
      uid=null; return;
    }
    uid = user.uid;
    authCard.classList.add('hide');
    filters.classList.remove('hide');
    listCard.classList.remove('hide');
    filterMonth.value = new Date().toISOString().slice(0, 7);

    const sRef = doc(db,'users',uid,'meta','settings');
    const snap = await getDoc(sRef);
    if(!snap.exists()){
      await setDoc(sRef, settings);
    } else {
      settings = { ...settings, ...snap.data() };
    }

    bindWorkplaceSelect(filterWorkplace, true);
    bindWorkplaceSelect(editWorkplace, false);

    const qRef = query(collection(db,'users',uid,'entries'), orderBy('date','desc'));
    onSnapshot(qRef, async s=>{
      const arr = []; s.forEach(d=>arr.push({id:d.id, ...d.data()}));
      entries = arr;
      await normalizeMissingCalculations(entries);
      render();
      hideLoader();
    });
  });

  loginBtn.onclick = async ()=>{ authMsg.textContent=''; try{ await signInWithEmailAndPassword(auth,emailEl.value.trim(),passEl.value); showLoader(); }catch(e){ authMsg.textContent=e.message; } };
  registerBtn.onclick = async ()=>{ authMsg.textContent=''; try{ await createUserWithEmailAndPassword(auth,emailEl.value.trim(),passEl.value); showLoader(); }catch(e){ authMsg.textContent=e.message; } };
  logoutBtn.onclick = ()=>{ showLoader(); signOut(auth); };

  [filterMonth, filterWorkplace, filterPatient].forEach(el=>{
    el.addEventListener('input', render);
    el.addEventListener('change', render);
  });

  function filtered(){
    const m = filterMonth.value;
    const w = filterWorkplace.value;
    const p = (filterPatient.value||'').toLowerCase().trim();
    return entries.filter(e=>{
      const okM = m ? (e.monthKey ? e.monthKey===m : monthKey(e.date)===m) : true;
      const okW = w ? e.workplace===w : true;
      const okP = p ? (e.patient||'').toLowerCase().includes(p) : true;
      return okM && okW && okP;
    });
  }

  function sortBySeq(list){
    // seq növekvő, hiányzó seq a végére
    return list.slice().sort((a,b)=>{
      const sa = (typeof a.seq==='number') ? a.seq : Number.POSITIVE_INFINITY;
      const sb = (typeof b.seq==='number') ? b.seq : Number.POSITIVE_INFINITY;
      if(sa!==sb) return sa - sb;
      const da = a.createdAt || new Date(a.date||'1970-01-01').getTime();
      const db = b.createdAt || new Date(b.date||'1970-01-01').getTime();
      return da - db;
    });
  }

  function render(){
    const list = sortBySeq(filtered());
    tableBody.innerHTML = '';
    let sumG = 0, sumO = 0;

    for(const e of list){
      const color = e.workplace===settings.w1name ? settings.w1color : settings.w2color;
      const pill = `<span class="pill" style="background:${color};color:${contrast(color)};border-color:${color}">${e.workplace||''}</span>`;

      const localPct = (e.pctAtSave != null) ? e.pctAtSave : pctFor(e.workplace);
      const localOwn = (e.ownAtSave != null) ? e.ownAtSave : Math.round((+e.amount||0) * localPct);

      sumG += +e.amount||0;
      sumO += +localOwn||0;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${(typeof e.seq==='number') ? e.seq : ''}</td>
        <td>${e.date||''}</td>
        <td>${e.patient||''}</td>
        <td>${e.procedure||''}</td>
        <td>${pill}</td>
        <td class="right">${fmt(e.amount)}</td>
        <td class="right">${localPct!=null? Math.round(localPct*100) + '%' : '-'}</td>
        <td class="right">${fmt(localOwn)}</td>
        <td class="right">
          <button class="btn" data-edit="${e.id}">Szerk.</button>
          <button class="btn danger" data-del="${e.id}">Törlés</button>
        </td>`;
      tableBody.appendChild(tr);
    }
    sumGrossEl.textContent = fmt(sumG);
    sumOwnEl.textContent = fmt(sumO);
  }

  document.getElementById('entriesTable').addEventListener('click', async (ev)=>{
    const id = ev.target.getAttribute('data-edit');
    const del = ev.target.getAttribute('data-del');
    if(id){
      const it = entries.find(x=>x.id===id);
      if(!it) return;
      editingId = id;
      editingOriginalMonthKey = it.monthKey || monthKey(it.date);
      editor.classList.remove('hide');
      editDate.value = it.date || '';
      editPatient.value = it.patient || '';
      editProcedure.value = it.procedure || '';
      editAmount.value = it.amount || 0;
      bindWorkplaceSelect(editWorkplace);
      const idx = Array.from(editWorkplace.options).findIndex(o=>o.value===it.workplace);
      editWorkplace.selectedIndex = idx>=0?idx:0;
      window.scrollTo({top:0,behavior:'smooth'});
    }else if(del){
      if(confirm('Biztosan törlöd?')){ await deleteDoc(doc(db,'users',uid,'entries',del)); }
    }
  });

  cancelEdit.onclick = ()=>{
    editingId = null; editingOriginalMonthKey = null;
    editor.classList.add('hide');
    editErr.classList.add('hide'); editMsg.classList.add('hide');
  };

  async function nextMonthlySeq(uid, month){
    // JAVÍTOTT ÚTVONAL: users/<uid>/counters/<YYYY-MM>
    const counterRef = doc(db,'users',uid,'counters',month);
    const seq = await runTransaction(db, async (tx)=>{
      const snap = await tx.get(counterRef);
      const cur = snap.exists() ? (snap.data().lastSeq||0) : 0;
      const next = cur + 1;
      tx.set(counterRef, { lastSeq: next }, { merge:true });
      return next;
    });
    return seq;
  }

  // MIGRÁLÁS: adott hónap sorszámainak beállítása
  async function migrateMonthSeq(month, onlyMissing=true){
    if(!uid) throw new Error('Nincs bejelentkezett felhasználó.');
    if(!month) throw new Error('Válassz hónapot a Szűrők között.');

    // Az aktuális entries tömbből dolgozunk (real-time snapshot alapján)
    const monthEntries = entries
      .filter(e => (e.monthKey ? e.monthKey===month : monthKey(e.date)===month))
      // rendezés: dátum növekvő, majd createdAt (ha van), majd id
      .sort((a,b)=>{
        const ad = new Date(a.date||'1970-01-01').getTime();
        const bd = new Date(b.date||'1970-01-01').getTime();
        if(ad!==bd) return ad-bd;
        const ac = a.createdAt || 0, bc = b.createdAt || 0;
        if(ac!==bc) return ac-bc;
        return (a.id||'').localeCompare(b.id||'');
      });

    let seq = 0;
    const ops = [];

    for(const e of monthEntries){
      if(onlyMissing && typeof e.seq === 'number') continue;
      seq += 1;
      const patch = { seq, monthKey: month };
      // biztos ami biztos: saját számítások frissítése, ha nem volt mentve
      const pct = (e.pctAtSave != null) ? e.pctAtSave : pctFor(e.workplace);
      const own = (e.ownAtSave != null) ? e.ownAtSave : Math.round((+e.amount||0) * pct);
      if(e.pctAtSave == null) patch.pctAtSave = pct;
      if(e.ownAtSave == null) patch.ownAtSave = own;

      ops.push(updateDoc(doc(db,'users',uid,'entries',e.id), patch).catch(()=>{}));
    }

    // Ha onlyMissing és mindennek volt seq, akkor is frissítsük a számlálót a max meglévőre
    if(onlyMissing && seq===0){
      // keresd meg a hónapban a legnagyobb meglévő seq-et
      const maxExisting = monthEntries.reduce((m,e)=> (typeof e.seq==='number' && e.seq>m)?e.seq:m, 0);
      seq = maxExisting;
    }

    if(ops.length) await Promise.all(ops);

    // számláló frissítése a hónap végső max értékére
    const counterRef = doc(db,'users',uid,'counters',month);
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(counterRef);
      const cur = snap.exists() ? (snap.data().lastSeq||0) : 0;
      const target = Math.max(cur, seq);
      tx.set(counterRef, { lastSeq: target }, { merge:true });
    });

    return { processed: ops.length, finalSeq: seq };
  }

  migrateBtn?.addEventListener('click', async ()=>{
    migrateMsg.textContent = '';
    try{
      const m = filterMonth.value;
      if(!m){ migrateMsg.textContent = 'Válassz hónapot a migráláshoz.'; return; }
      showLoader();
      const onlyMissing = !!migrateOnlyMissing.checked;
      const res = await migrateMonthSeq(m, onlyMissing);
      migrateMsg.textContent = `Kész. Módosított bejegyzések: ${res.processed}. Utolsó sorszám: ${res.finalSeq}.`;
    }catch(err){
      migrateMsg.textContent = err?.message || 'Migrálási hiba történt.';
    }finally{
      hideLoader();
    }
  });

  saveEdit.onclick = async ()=>{
    if(!editingId) return;
    editMsg.classList.add('hide'); editErr.classList.add('hide'); editErr.textContent='';

    const payload = {
      date: editDate.value,
      patient: editPatient.value.trim(),
      procedure: editProcedure.value.trim(),
      amount: Math.max(0, Math.round(+editAmount.value||0)),
      workplace: editWorkplace.value
    };
    if(!payload.date || !payload.patient || !payload.procedure || !payload.amount || !payload.workplace){
      editErr.textContent = 'Minden mező kötelező (dátum, páciens, beavatkozás, összeg, munkahely).';
      editErr.classList.remove('hide'); return;
    }
    const newMonthKey = monthKey(payload.date);
    if(!newMonthKey){ editErr.textContent='Érvénytelen dátum.'; editErr.classList.remove('hide'); return; }

    const pct = pctFor(payload.workplace);
    const own = Math.round(payload.amount * pct);

    try{
      const patch = {
        ...payload,
        pctAtSave: pct,
        ownAtSave: own,
        monthKey: newMonthKey,
        updatedAt: Date.now()
      };
      if(newMonthKey !== editingOriginalMonthKey){
        const newSeq = await nextMonthlySeq(uid, newMonthKey);
        patch.seq = newSeq;
      }
      await updateDoc(doc(db,'users',uid,'entries',editingId), patch);
      editMsg.classList.remove('hide');
      setTimeout(()=>{ editMsg.classList.add('hide'); editor.classList.add('hide'); }, 1200);
      editingId = null; editingOriginalMonthKey = null;
    }catch(err){
      editErr.textContent = err?.message || 'Mentési hiba';
      editErr.classList.remove('hide');
    }
  };
</script>
</body>
</html>
