<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bevételek – Fogorvosi bevételkövető</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e6eaf1;--primary:#2563eb;--danger:#ef4444;--shadow:0 6px 25px rgba(15,23,42,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  .layout{max-width:1100px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:16px}
  h1{margin:0 0 6px;font-size:20px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;text-decoration:none;color:inherit}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted);font-weight:600}
  .right{text-align:right}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;font-weight:600}
  .ktable{width:100%;overflow:auto}
  .total{font-weight:700}
  .muted{color:var(--muted);font-size:12px}
  .hide{display:none}
  .ok{padding:8px 10px;border-radius:10px;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}
  .err{padding:8px 10px;border-radius:10px;background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}
</style>
</head>
<body>
<div class="layout">
  <div class="topbar">
    <h1>Bevételek</h1>
    <div>
      <a class="btn" href="index.html">Rögzítés</a>
      <a class="btn" href="settings.html">Beállítások</a>
      <button class="btn" id="logoutBtn">Kijelentkezés</button>
    </div>
  </div>

  <div class="card" id="authCard">
    <div class="row2">
      <div>
        <label>E-mail</label>
        <input id="email" type="email">
      </div>
      <div>
        <label>Jelszó</label>
        <input id="password" type="password">
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button class="btn primary" id="loginBtn">Belépés</button>
      <button class="btn" id="registerBtn">Regisztráció</button>
    </div>
    <div class="muted" id="authMsg"></div>
  </div>

  <div class="card hide" id="filters">
    <h2>Szűrők</h2>
    <div class="row">
      <div>
        <label>Hónap</label>
        <input type="month" id="filterMonth">
      </div>
      <div>
        <label>Munkahely</label>
        <!-- NEW: „Összesen” mint alapértelmezett -->
        <select id="filterWorkplace">
          <option value="">Összesen</option>
        </select>
      </div>
      <div>
        <label>Páciens</label>
        <input id="filterPatient" placeholder="Keresés névre">
      </div>
    </div>
  </div>

  <div class="card hide" id="editor">
    <h2>Szerkesztés</h2>
    <div id="editMsg" class="ok hide">Mentve ✓</div>
    <div id="editErr" class="err hide"></div>

    <div class="row">
      <div>
        <label>Dátum</label>
        <input id="editDate" type="date">
      </div>
      <div>
        <label>Páciens</label>
        <input id="editPatient">
      </div>
      <div>
        <label>Beavatkozás</label>
        <input id="editProcedure">
      </div>
    </div>
    <div class="row2" style="margin-top:10px">
      <div>
        <label>Összeg (HUF)</label>
        <input id="editAmount" type="number" min="0" step="1">
      </div>
      <div>
        <label>Munkahely</label>
        <select id="editWorkplace"></select>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">
      Mentéskor a kiválasztott munkahely aktuális %-ával számoljuk a saját részt (és eltároljuk a bejegyzésben).
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn" id="cancelEdit">Mégse</button>
      <button class="btn primary" id="saveEdit">Mentés</button>
    </div>
  </div>

  <div class="card hide" id="listCard">
    <h2>Bejegyzések</h2>
    <div class="ktable">
      <table id="entriesTable">
        <thead>
          <tr>
            <th>Dátum</th>
            <th>Páciens</th>
            <th>Beavatkozás</th>
            <th>Munkahely</th>
            <th class="right">Fizetett</th>
            <th class="right">%-om</th>
            <th class="right">Saját</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="4" class="right total">Összesen (szűrt):</td>
            <td class="right total" id="sumGross">0</td>
            <td></td>
            <td class="right total" id="sumOwn">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query, orderBy, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGVBozEiKhqOqvvYB9Qsm1xCLrsw0itNI",
    authDomain: "dental-38375.firebaseapp.com",
    projectId: "dental-38375",
    storageBucket: "dental-38375.appspot.com",
    messagingSenderId: "245424156358",
    appId: "1:245424156358:web:e6426588b20675756331c7",
    measurementId: "G-WC90WMHRZT"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI
  const authCard = document.getElementById('authCard');
  const filters = document.getElementById('filters');
  const listCard = document.getElementById('listCard');
  const editor = document.getElementById('editor');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const authMsg = document.getElementById('authMsg');

  const filterMonth = document.getElementById('filterMonth');
  const filterWorkplace = document.getElementById('filterWorkplace');
  const filterPatient = document.getElementById('filterPatient');

  const tableBody = document.querySelector('#entriesTable tbody');
  const sumGrossEl = document.getElementById('sumGross');
  const sumOwnEl = document.getElementById('sumOwn');

  const editDate = document.getElementById('editDate');
  const editPatient = document.getElementById('editPatient');
  const editProcedure = document.getElementById('editProcedure');
  const editAmount = document.getElementById('editAmount');
  const editWorkplace = document.getElementById('editWorkplace');
  const saveEdit = document.getElementById('saveEdit');
  const cancelEdit = document.getElementById('cancelEdit');
  const editMsg = document.getElementById('editMsg');
  const editErr = document.getElementById('editErr');

  let uid = null;
  let entries = [];
  let settings = { w1name:'Hely1', w1pct:0.30, w1color:'#2563eb', w2name:'Hely2', w2pct:0.40, w2color:'#16a34a' };
  let editingId = null;

  // --- helpers ---
  const hexToRgb = (hex)=>{
    const h = hex.replace('#','');
    const b = parseInt(h.length===3? h.split('').map(x=>x+x).join(''):h,16);
    return {r:(b>>16)&255,g:(b>>8)&255,b:b&255};
  };
  const contrast = (hex)=>{ const {r,g,b} = hexToRgb(hex||'#999'); const yiq=(r*299+g*587+b*114)/1000; return yiq>=128?'#000':'#fff'; };
  const fmt = n => (n||0).toLocaleString('hu-HU',{maximumFractionDigits:0});
  const monthKey = d => { const dt=new Date(d); return isNaN(dt)?'':dt.toISOString().slice(0,7); };
  function pctFor(place){ if(place===settings.w1name) return +settings.w1pct||0; if(place===settings.w2name) return +settings.w2pct||0; return 0; }

  function bindWorkplaceSelect(select, withAll=false){
    select.innerHTML = '';
    if(withAll){
      const all = document.createElement('option'); all.value=''; all.textContent='Összesen'; select.appendChild(all);
    }
    [settings.w1name, settings.w2name].forEach(n=>{
      const o=document.createElement('option'); o.value=n; o.textContent=n; select.appendChild(o);
    });
    if(withAll) select.selectedIndex = 0; // alapértelmezett: Összesen
  }

  // snapshot frissítésekor ne számoljuk újra végtelenségig
  const updatedOnce = new Set(); // id-k, amelyeket már normalizáltunk

  async function normalizeMissingCalculations(list){
    const ops = [];
    for(const e of list){
      const shouldHavePct = pctFor(e.workplace);
      const computedOwn = Math.round((+e.amount||0) * shouldHavePct);

      const missingPct = (e.pctAtSave == null);
      const missingOwn = (e.ownAtSave == null);
      const wrongOwn = (!missingOwn && e.ownAtSave !== computedOwn);

      if((missingPct || missingOwn || wrongOwn) && !updatedOnce.has(e.id)){
        updatedOnce.add(e.id);
        ops.push(
          updateDoc(doc(db,'users',uid,'entries',e.id), {
            pctAtSave: shouldHavePct,
            ownAtSave: computedOwn
          }).catch(()=>{}) // ha nincs jogosultság/hiba, ne álljon meg a többi
        );
      }
    }
    if(ops.length) await Promise.all(ops);
  }

  onAuthStateChanged(auth, async user=>{
    if(!user){
      authCard.classList.remove('hide');
      filters.classList.add('hide');
      listCard.classList.add('hide');
      editor.classList.add('hide');
      uid=null; return;
    }
    uid = user.uid;
    authCard.classList.add('hide');
    filters.classList.remove('hide');
    listCard.classList.remove('hide');

    // >>> Alapértelmezett: aktuális hónap (YYYY-MM) + első render
    filterMonth.value = new Date().toISOString().slice(0, 7);
    render();

    // settings betöltés
    const sRef = doc(db,'users',uid,'meta','settings');
    const snap = await getDoc(sRef);
    if(!snap.exists()){
      await setDoc(sRef, settings); // default
    } else {
      settings = { ...settings, ...snap.data() };
    }

    // legördülők
    bindWorkplaceSelect(filterWorkplace, /*withAll*/ true);
    bindWorkplaceSelect(editWorkplace, /*withAll*/ false);

    // entries realtime
    const qRef = query(collection(db,'users',uid,'entries'), orderBy('date','desc'));
    onSnapshot(qRef, async s=>{
      const arr = []; s.forEach(d=>arr.push({id:d.id, ...d.data()}));
      entries = arr;

      // NEW: automatikus számítás/kitöltés hiányzó vagy rossz értékekre
      await normalizeMissingCalculations(entries);

      render();
    });
  });

  loginBtn.onclick = async ()=>{ authMsg.textContent=''; try{ await signInWithEmailAndPassword(auth,emailEl.value.trim(),passEl.value); }catch(e){ authMsg.textContent=e.message; } };
  registerBtn.onclick = async ()=>{ authMsg.textContent=''; try{ await createUserWithEmailAndPassword(auth,emailEl.value.trim(),passEl.value); }catch(e){ authMsg.textContent=e.message; } };
  logoutBtn.onclick = ()=>signOut(auth);

  [filterMonth, filterWorkplace, filterPatient].forEach(el=>{
    el.addEventListener('input', render);
    el.addEventListener('change', render);
  });

  function filtered(){
    const m = filterMonth.value;
    const w = filterWorkplace.value;
    const p = (filterPatient.value||'').toLowerCase().trim();
    return entries.filter(e=>{
      const okM = m ? monthKey(e.date)===m : true;
      const okW = w ? e.workplace===w : true; // üres = Összesen
      const okP = p ? (e.patient||'').toLowerCase().includes(p) : true;
      return okM && okW && okP;
    });
  }

  function render(){
    const list = filtered();
    tableBody.innerHTML = '';
    let sumG = 0, sumO = 0;

    for(const e of list){
      const color = e.workplace===settings.w1name ? settings.w1color : settings.w2color;
      const pill = `<span class="pill" style="background:${color};color:${contrast(color)};border-color:${color}">${e.workplace||''}</span>`;

      // Ha még nem frissült Firestore-ban, számoljuk ki megjelenítéshez helyben is:
      const localPct = (e.pctAtSave != null) ? e.pctAtSave : pctFor(e.workplace);
      const localOwn = (e.ownAtSave != null) ? e.ownAtSave : Math.round((+e.amount||0) * localPct);

      sumG += +e.amount||0;
      sumO += +localOwn||0;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${e.date||''}</td>
        <td>${e.patient||''}</td>
        <td>${e.procedure||''}</td>
        <td>${pill}</td>
        <td class="right">${fmt(e.amount)}</td>
        <td class="right">${localPct!=null? Math.round(localPct*100) + '%' : '-'}</td>
        <td class="right">${fmt(localOwn)}</td>
        <td class="right">
          <button class="btn" data-edit="${e.id}">Szerk.</button>
          <button class="btn danger" data-del="${e.id}">Törlés</button>
        </td>`;
      tableBody.appendChild(tr);
    }
    sumGrossEl.textContent = fmt(sumG);
    sumOwnEl.textContent = fmt(sumO);
  }

  document.getElementById('entriesTable').addEventListener('click', async (ev)=>{
    const id = ev.target.getAttribute('data-edit');
    const del = ev.target.getAttribute('data-del');
    if(id){
      const it = entries.find(x=>x.id===id);
      if(!it) return;
      editingId = id;
      editor.classList.remove('hide');
      editDate.value = it.date || '';
      editPatient.value = it.patient || '';
      editProcedure.value = it.procedure || '';
      editAmount.value = it.amount || 0;
      bindWorkplaceSelect(editWorkplace);
      const idx = Array.from(editWorkplace.options).findIndex(o=>o.value===it.workplace);
      editWorkplace.selectedIndex = idx>=0?idx:0;
      window.scrollTo({top:0,behavior:'smooth'});
    }else if(del){
      if(confirm('Biztosan törlöd?')){
        await deleteDoc(doc(db,'users',uid,'entries',del));
      }
    }
  });

  cancelEdit.onclick = ()=>{
    editingId = null;
    editor.classList.add('hide');
    editErr.classList.add('hide');
    editMsg.classList.add('hide');
  };

  saveEdit.onclick = async ()=>{
    if(!editingId) return;
    editMsg.classList.add('hide'); editErr.classList.add('hide'); editErr.textContent='';

    const payload = {
      date: editDate.value,
      patient: editPatient.value.trim(),
      procedure: editProcedure.value.trim(),
      amount: Math.max(0, Math.round(+editAmount.value||0)),
      workplace: editWorkplace.value
    };
    if(!payload.date || !payload.patient || !payload.procedure || !payload.amount || !payload.workplace){
      editErr.textContent = 'Minden mező kötelező (dátum, páciens, beavatkozás, összeg, munkahely).';
      editErr.classList.remove('hide'); return;
    }
    const pct = pctFor(payload.workplace);
    const own = Math.round(payload.amount * pct);

    try{
      await updateDoc(doc(db,'users',uid,'entries',editingId), {
        ...payload,
        pctAtSave: pct,
        ownAtSave: own,
        updatedAt: Date.now()
      });
      editMsg.classList.remove('hide');
      setTimeout(()=>{ editMsg.classList.add('hide'); editor.classList.add('hide'); }, 1200);
    }catch(err){
      editErr.textContent = err?.message || 'Mentési hiba';
      editErr.classList.remove('hide');
    }
  };
</script>
</body>
</html>
